<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Soccer Card Games</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }

    /* Fix Safari tap */
    button { cursor:pointer; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
    .btn, .setup-button, .btn-view-hand, .trash-btn, .btn-close-sidebar, .modal-close { cursor:pointer; }
    .defense-card-overlay { pointer-events:none; }

    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      padding: 12px;
    }

    .setup-page {
      max-width: 650px;
      margin: 30px auto;
      background: linear-gradient(135deg, #2d7a3f 0%, #267033 100%);
      border-radius: 12px;
      border: 5px solid #fff;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
      padding: 25px;
      position: relative;
      overflow: hidden;
    }
    .setup-page.hidden { display:none; }

    .setup-content { position:relative; z-index:2; }
    .setup-title {
      text-align:center; color:white; font-size:1.4em; font-weight:bold;
      margin-bottom:25px; text-shadow:2px 2px 4px rgba(0,0,0,0.5);
    }
    .setup-teams {
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:20px;
      margin-bottom:25px;
    }

    .team-setup {
      background: rgba(255,255,255,0.95);
      padding:18px;
      border-radius:8px;
      box-shadow:0 4px 12px rgba(0,0,0,0.3);
    }

    .team-setup-label {
      font-size:0.9em;
      font-weight:bold;
      margin-bottom:8px;
      color:#333;
      display:block;
    }

    .team-name-header {
      font-size:0.85em;
      color:#666;
      text-align:center;
      margin-bottom:5px;
    }

    .team-name-display {
      font-size:1.1em;
      font-weight:bold;
      text-align:center;
      margin-bottom:10px;
      color:#333;
    }

    .setup-input {
      width:100%;
      padding:8px;
      font-size:0.9em;
      border:2px solid #ddd;
      border-radius:6px;
      margin-bottom:10px;
      font-family: Arial, sans-serif;
    }
    .setup-input:focus { outline:none; border-color:#2E7D32; }

    .setup-select {
      width:100%;
      padding:8px;
      font-size:0.9em;
      border:2px solid #ddd;
      border-radius:6px;
      background:white;
      cursor:pointer;
      font-family: Arial, sans-serif;
    }
    .setup-select:focus { outline:none; border-color:#2E7D32; }

    .setup-button {
      display:block;
      width:100%;
      max-width:300px;
      margin:0 auto;
      padding:12px 24px;
      font-size:1em;
      font-weight:bold;
      color:white;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border:none;
      border-radius:8px;
      transition: all 0.3s ease;
      box-shadow:0 4px 12px rgba(0,0,0,0.3);
    }
    .setup-button:hover:not(:disabled){
      transform: translateY(-3px);
      box-shadow:0 6px 20px rgba(102,126,234,0.6);
    }
    .setup-button:disabled { opacity:0.5; cursor:not-allowed; }
    .game-container {
      max-width: 1400px;
      margin: 0 auto;
      display: none;
      flex-direction: column;
      gap: 10px;
    }
    .game-container.visible { display:flex; }

    .game-header {
      background: linear-gradient(135deg, #2E7D32, #388E3C);
      border-radius: 8px;
      padding: 10px 20px;
      display:flex; justify-content:space-between; align-items:center;
      box-shadow:0 4px 12px rgba(0,0,0,0.3);
      color:white;
    }

    .player-area {
      background: rgba(33,150,243,0.2);
      border:3px solid rgba(33,150,243,0.5);
      border-radius:8px; padding:12px; min-height:80px;
      transition: all .3s ease; position:relative;
    }
    .player-area.defense {
      background: rgba(244,67,54,0.2);
      border:3px solid rgba(244,67,54,0.5);
      min-height:140px;
    }
    .player-area.active {
      border-color:#FFD700; box-shadow:0 0 20px rgba(255,215,0,.5); background: rgba(255,215,0,.15);
    }
    .player-area.disabled { opacity:.5; pointer-events:none; }

    .player-label {
      color:white; font-weight:bold; font-size:.8em; margin-bottom:10px; text-align:center;
      display:flex; justify-content:center; align-items:center; gap:10px; flex-wrap:wrap;
    }
    .team-name-badge { font-weight:bold; font-size:1em; color:white; }
    .role-badge { padding:3px 10px; border-radius:12px; font-size:.85em; font-weight:bold; }
    .role-badge.attack { background: linear-gradient(135deg,#E53935,#C62828); color:white; }
    .role-badge.defense{ background: linear-gradient(135deg,#1976D2,#1565C0); color:white; }

    .btn-view-hand {
      background: linear-gradient(135deg,#667eea,#764ba2); color:white; border:none; padding:4px 12px;
      border-radius:6px; font-weight:bold; font-size:.85em; transition: all .3s ease; margin-left:auto;
    }
    .btn-view-hand:hover { transform: scale(1.05); box-shadow:0 4px 12px rgba(102,126,234,.6); }

    .cards-container { display:flex; justify-content:center; align-items:center; gap:8px; flex-wrap:wrap; }

    .soccer-field {
      background: linear-gradient(135deg, #2d7a3f 0%, #267033 100%);
      border-radius:10px; padding:20px; border:5px solid #fff;
      box-shadow:0 8px 24px rgba(0,0,0,.4); position:relative; min-height:400px;
    }
    .field-svg { width:100%; height:350px; position:relative; }

    .action-status {
      position:absolute; top:10px; left:50%; transform: translateX(-50%);
      background:rgba(255,255,255,.95); padding:8px 20px; border-radius:8px; font-size:.8em; font-weight:bold;
      color:#2E7D32; text-align:center; z-index:100; box-shadow:0 4px 12px rgba(0,0,0,.3); max-width:80%;
    }
    .time-indicator {
      position:absolute; top:10px; right:15px; background: rgba(0,0,0,.85); color:white;
      padding:8px 15px; border-radius:8px; font-weight:bold; font-size:.85em; border:2px solid #FFD700;
      box-shadow:0 4px 12px rgba(0,0,0,.5); z-index:90; text-shadow:1px 1px 2px rgba(0,0,0,.5);
    }

    .field-position { position:absolute; display:flex; justify-content:center; align-items:center; gap:5px; }

    .carta {
      width: clamp(45px, 5vw, 75px);
      height: clamp(66px, 7.3vw, 110px);
      border-radius:8px; padding:8px; display:flex; flex-direction:column; align-items:center; justify-content:space-around;
      transition: all .3s ease; box-shadow:0 4px 8px rgba(0,0,0,.4); color:white; font-weight:bold;
      border:2px solid rgba(255,255,255,.4);
    }
    .carta:not(.disabled):not(.in-sidebar):not(.played):hover {
      transform: translateY(-12px) scale(1.06); box-shadow:0 12px 24px rgba(0,0,0,.6); border-color:#FFD700;
    }
    .carta.disabled { opacity:.5; cursor:not-allowed; }
    .carta.playable { border:4px solid #FFD700; box-shadow:0 0 20px rgba(255,215,0,.8); animation: pulse 2s infinite; }
    @keyframes pulse { 0%,100%{box-shadow:0 0 20px rgba(255,215,0,.8);} 50%{box-shadow:0 0 30px rgba(255,215,0,1);} }
    .carta.played {
      width: clamp(45px, 5vw, 75px); height: clamp(66px, 7.3vw, 110px); opacity:.6; cursor:default; filter:grayscale(60%);
      padding:8px; border:2px solid rgba(255,255,255,.3);
    }
    .carta.in-sidebar { cursor: default; }
    .carta.in-sidebar.playable { cursor:pointer; }
    .carta.in-sidebar.playable:hover { transform: scale(1.05); box-shadow:0 0 25px rgba(255,215,0,1); }
    .carta-icona { font-size: clamp(18px, 2vw, 28px); }
    .carta-nome { font-size: clamp(5px, .5vw, 7.5px); text-align:center; line-height:1.1; }
    .carta-posizione { font-size: clamp(7px, .8vw, 11px); background: rgba(255,255,255,.3); padding:3px 8px; border-radius:5px; }

    .difensore{ background: linear-gradient(135deg,#1976D2,#1565C0); }
    .mediano{ background: linear-gradient(135deg,#00897B,#00695C); }
    .centrocampista{ background: linear-gradient(135deg,#FBC02D,#F9A825); }
    .attaccante{ background: linear-gradient(135deg,#E53935,#C62828); }
    .jolly{ background: linear-gradient(135deg,#9C27B0,#7B1FA2); }
    .var{ background: linear-gradient(135deg,#FF5722,#E64A19); }

    .contrasto-vincente{ background: linear-gradient(135deg,#4CAF50,#388E3C); }
    .contropiede{ background: linear-gradient(135deg,#8BC34A,#689F38); }
    .contrasto-perdente{ background: linear-gradient(135deg,#9E9E9E,#757575); }
    .parata{ background: linear-gradient(135deg,#2196F3,#1976D2); }
    .fallo-tattico{ background: linear-gradient(135deg,#FFC107,#FFA000); }
    .fallo-laterale{ background: linear-gradient(135deg,#FF9800,#F57C00); }
    .fallo-rigore{ background: linear-gradient(135deg,#F44336,#D32F2F); }
    .calcio-angolo{ background: linear-gradient(135deg,#00BCD4,#0097A7); }
    .fuorigioco{ background: linear-gradient(135deg,#673AB7,#512DA8); }
    .sostituzione{ background: linear-gradient(135deg,#607D8B,#455A64); }

    .sidebar {
      position:fixed; top:0; width:285px; height:100vh; background: rgba(22,33,62,.98);
      box-shadow:0 0 20px rgba(0,0,0,.5); transition: all .3s ease; z-index:1000;
      display:flex; flex-direction:column; overflow:hidden;
    }
    .sidebar.sidebar-left { left:-285px; border-right:3px solid #FF5722; }
    .sidebar.sidebar-left.open { left:0; }
    .sidebar.sidebar-right { right:-285px; border-left:3px solid #667eea; }
    .sidebar.sidebar-right.open { right:0; }

    .sidebar-header { padding:15px; color:white; display:flex; justify-content:space-between; align-items:center; }
    .sidebar-left .sidebar-header{ background: linear-gradient(135deg,#f44336,#E53935); }
    .sidebar-right .sidebar-header{ background: linear-gradient(135deg,#667eea,#764ba2); }
    .sidebar-header h3 { font-size:1.1em; }

    .btn-close-sidebar {
      background:transparent; border:none; color:white; font-size:1.5em; padding:0; width:30px; height:30px;
      display:flex; align-items:center; justify-content:center;
    }

    .sidebar-content{ flex:1; overflow-y:auto; padding:15px; }
    .hand-section{ margin-bottom:20px; }
    .hand-section h4{ font-size:.9em; margin-bottom:10px; padding-bottom:5px; border-bottom:2px solid rgba(255,215,0,.3); }
    .sidebar-left .hand-section h4{ color:#FF5722; }
    .sidebar-right .hand-section h4{ color:#FFD700; }
    .hand-cards-grid{ display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; }

    .btn {
      background: linear-gradient(135deg,#667eea,#764ba2); color:white; border:none; padding:8px 16px; border-radius:6px;
      font-weight:bold; font-size:.75em; transition: all .3s ease;
    }
    .btn:hover{ transform: translateY(-2px); box-shadow:0 6px 16px rgba(102,126,234,.6); }
    .btn:disabled{ opacity:.5; cursor:not-allowed; transform:none; }
    .btn-reset{ background: linear-gradient(135deg,#FF9800,#F57C00); }

    .btn-draw-card{
      position:absolute; top:50%; left:50%; transform: translate(-50%, -50%);
      background: linear-gradient(135deg,#667eea,#764ba2); width:80px; height:80px; border-radius:50%;
      border:2px solid #FFD700; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:0;
      transition: all .3s ease; box-shadow:0 4px 8px rgba(0,0,0,.3); z-index:50;
    }
    .btn-draw-card:hover{ transform: translate(-50%, -50%) scale(1.05); box-shadow:0 6px 16px rgba(102,126,234,.6); }

    .controls{
      background: rgba(255,255,255,.1); border-radius:8px; padding:10px;
      display:flex; gap:10px; justify-content:center; align-items:center;
    }

    .info-box{
      background:#FFF9E6; color:#856404; padding:10px; border-radius:8px; border-left:4px solid #FFD700;
      font-size:.7em; line-height:1.4;
    }

    .result-banner{
      background: linear-gradient(135deg,#4CAF50,#45a049); color:white; padding:15px; border-radius:8px; text-align:center;
      font-size:1.2em; font-weight:bold; animation: slideIn .5s ease;
    }
    .result-banner.fail{ background: linear-gradient(135deg,#f44336,#da190b); }
    @keyframes slideIn{ from{ transform: translateY(-20px); opacity:0; } to{ transform: translateY(0); opacity:1; } }

    .trash-btn{
      position:absolute; bottom:10px; right:10px;
      background: linear-gradient(135deg, #2d7a3f 0%, #267033 100%);
      border:none; border-radius:8px; padding:8px 12px; font-size:32px; transition: all .3s ease; z-index:20;
      box-shadow:0 4px 8px rgba(0,0,0,.3);
    }
    .trash-btn:hover:not(:disabled){ transform: scale(1.1); box-shadow: 0 4px 12px rgba(0,0,0,.4); }
    .trash-btn:disabled{ opacity:.5; cursor:not-allowed; }

    .modal{
      display:none; position:fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,.7); z-index:2000; justify-content:center; align-items:center;
    }
    .modal.open{ display:flex; }

    .modal-content{
      background: linear-gradient(135deg,#667eea,#764ba2);
      border-radius:12px; padding:30px; max-width:90%; max-height:90%; overflow-y:auto; position:relative;
      box-shadow:0 8px 32px rgba(0,0,0,.5);
    }
    .modal-close{
      position:absolute; top:15px; right:15px; background:transparent; border:none; color:white; font-size:2em;
      padding:0; width:40px; height:40px;
    }
    .modal-close:hover{ color:#FFD700; }

    .modal h2{ color:white; text-align:center; margin-bottom:30px; font-size:1.5em; }

    .discard-section{ margin-bottom:30px; }
    .discard-section h3{ color:#FFD700; margin-bottom:15px; font-size:1.2em; }
    .discard-grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); gap:8px; }

    .carta-small{
      width:40px; height:60px; border-radius:4px; padding:4px; display:flex; flex-direction:column; align-items:center; justify-content:space-around;
      transition: all .3s ease; box-shadow:0 2px 4px rgba(0,0,0,.4); color:white; font-weight:bold; border:1px solid rgba(255,255,255,.4);
      position:relative;
    }
    .carta-small:hover{ transform: scale(2.5); z-index:9999; box-shadow:0 8px 24px rgba(0,0,0,.8); }
    .carta-small .carta-icona{ font-size:14px; }
    .carta-small .carta-nome{ font-size:4px; text-align:center; line-height:1; }
    .carta-small .carta-posizione{ font-size:6px; background: rgba(255,255,255,.3); padding:1px 3px; border-radius:2px; }
  </style>
</head>
<body>
  <div class="setup-page" id="setupPage">
    <div class="setup-content">
      <div class="setup-title">⚽ SOCCER CARD GAMES ⚽</div>

      <div class="setup-teams">
        <div class="team-setup">
          <label class="team-setup-label">Nome Squadra</label>
          <div class="team-name-header" id="redTeamNameHeader" style="display:none;">Nome Squadra</div>
          <div class="team-name-display" id="redTeamNameDisplay" style="display:none;"></div>
          <input type="text" class="setup-input" id="redTeamName" placeholder="Inserisci nome squadra" maxlength="20">
          <button class="btn-view-hand" type="button" onclick="openSidebarSetup('defense')" id="btnViewRedCards" style="display:none; margin-bottom:10px; width:100%;">
            CARTE GIOCATORE <span id="redNameBtn"></span>
          </button>
          <select class="setup-select" id="redTeamModule" style="display:none;">
            <option value="">Scegli Modulo</option>
            <option value="4-3-3">4-3-3</option>
            <option value="3-3-4">3-3-4</option>
            <option value="3-4-3">3-4-3</option>
            <option value="4-2-3-1">4-2-3-1</option>
            <option value="4-3-1-2">4-3-1-2</option>
            <option value="3-5-2">3-5-2</option>
          </select>
        </div>

        <div class="team-setup">
          <label class="team-setup-label">Nome Squadra</label>
          <div class="team-name-header" id="blueTeamNameHeader" style="display:none;">Nome Squadra</div>
          <div class="team-name-display" id="blueTeamNameDisplay" style="display:none;"></div>
          <input type="text" class="setup-input" id="blueTeamName" placeholder="Inserisci nome squadra" maxlength="20">
          <button class="btn-view-hand" type="button" onclick="openSidebarSetup('attack')" id="btnViewBlueCards" style="display:none; margin-bottom:10px; width:100%;">
            CARTE GIOCATORE <span id="blueNameBtn"></span>
          </button>
          <select class="setup-select" id="blueTeamModule" style="display:none;">
            <option value="">Scegli Modulo</option>
            <option value="4-3-3">4-3-3</option>
            <option value="3-3-4">3-3-4</option>
            <option value="3-4-3">3-4-3</option>
            <option value="4-2-3-1">4-2-3-1</option>
            <option value="4-3-1-2">4-3-1-2</option>
            <option value="3-5-2">3-5-2</option>
          </select>
        </div>
      </div>

      <button class="setup-button" id="btnDistributeCards" type="button" disabled>
        🎴 DISTRIBUISCI CARTE
      </button>
      <button class="setup-button" id="btnStartGame" type="button" disabled style="display:none; font-size:1em; padding:12px 24px;">
        🎮 INIZIA PARTITA
      </button>
    </div>
  </div>

  <div class="game-container" id="gameContainer">
    <div class="game-header">
      <div style="font-size: 0.85em;">
        Nome Squadra: <span id="redTeamHeader"></span> Goal: <span id="redScore">0</span>
      </div>
      <div style="text-align: center; font-size: 0.85em; font-weight: bold;">
        SOCCER CARD GAMES
      </div>
      <div style="text-align: right; font-size: 0.85em;">
        Nome Squadra: <span id="blueTeamHeader"></span> Goal: <span id="blueScore">0</span>
      </div>
    </div>

    <div class="player-area" id="defenseArea">
      <div class="player-label" id="defenseLabel"></div>
      <div class="cards-container" id="defenseHand"></div>
    </div>

    <div class="soccer-field">
      <div class="action-status" id="actionStatus"></div>
      <div class="time-indicator" id="timeIndicator">🕐 1° TEMPO</div>

      <svg class="field-svg" viewBox="0 0 700 350" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <pattern id="netPattern" width="8" height="8" patternUnits="userSpaceOnUse">
            <path d="M0,0 L8,8 M8,0 L0,8" stroke="rgba(255,255,255,0.5)" stroke-width="0.8"/>
          </pattern>
        </defs>

        <rect x="20" y="50" width="660" height="250" fill="#2d7a3f" stroke="#fff" stroke-width="3"/>
        <line x1="350" y1="50" x2="350" y2="300" stroke="#fff" stroke-width="2"/>
        <circle cx="350" cy="175" r="40" fill="none" stroke="#fff" stroke-width="2"/>
        <circle cx="350" cy="175" r="3" fill="#fff"/>

        <rect x="20" y="125" width="70" height="100" fill="none" stroke="#fff" stroke-width="2"/>
        <line x1="20" y1="155" x2="50" y2="155" stroke="#fff" stroke-width="2"/>
        <line x1="50" y1="155" x2="50" y2="195" stroke="#fff" stroke-width="2"/>
        <line x1="50" y1="195" x2="20" y2="195" stroke="#fff" stroke-width="2"/>
        <circle cx="70" cy="175" r="2" fill="#fff"/>

        <rect x="610" y="125" width="70" height="100" fill="none" stroke="#fff" stroke-width="2"/>
        <line x1="680" y1="155" x2="650" y2="155" stroke="#fff" stroke-width="2"/>
        <line x1="650" y1="155" x2="650" y2="195" stroke="#fff" stroke-width="2"/>
        <line x1="650" y1="195" x2="680" y2="195" stroke="#fff" stroke-width="2"/>
        <circle cx="630" cy="175" r="2" fill="#fff"/>

        <rect x="10" y="155" width="10" height="40" fill="url(#netPattern)" stroke="#fff" stroke-width="1"/>
        <rect x="20" y="155" width="15" height="40" fill="none" stroke="#fff" stroke-width="2"/>
        <rect x="680" y="155" width="10" height="40" fill="url(#netPattern)" stroke="#fff" stroke-width="1"/>
        <rect x="665" y="155" width="15" height="40" fill="none" stroke="#fff" stroke-width="2"/>

        <path d="M 20,50 L 20,62 A 12,12 0 0,1 32,50 Z" fill="#fff" stroke="#fff" stroke-width="1"/>
        <path d="M 680,50 L 668,50 A 12,12 0 0,1 680,62 Z" fill="#fff" stroke="#fff" stroke-width="1"/>
        <path d="M 20,300 L 32,300 A 12,12 0 0,1 20,288 Z" fill="#fff" stroke="#fff" stroke-width="1"/>
        <path d="M 680,300 L 680,288 A 12,12 0 0,1 668,300 Z" fill="#fff" stroke="#fff" stroke-width="1"/>
      </svg>

      <div id="fieldCards"></div>

      <button class="trash-btn" id="mazzoBtn" type="button" onclick="openMazzoModal()" style="left: 10px; right: auto;">📚</button>
      <button class="trash-btn" id="trashBtn" type="button" onclick="openDiscardModal()" disabled>🗑️</button>
    </div>

    <div class="player-area active" id="attackArea">
      <div class="player-label" id="attackLabel"></div>
    </div>

    <div class="controls">
      <button class="btn" type="button" onclick="startAction()">▶️ INIZIA AZIONE</button>
      <button class="btn btn-reset" type="button" onclick="resetGame()">🔄 RICOMINCIA</button>
    </div>

    <div class="info-box">
      <strong>🎮 CAMPO VISUALE:</strong><br>
      <strong>🏟️ CAMPO:</strong> Le carte attacco appaiono sul campo, quelle giocate restano visibili (piccole e grigie)<br>
      <strong>🌟 BORDO ORO:</strong> Indica le carte giocabili<br>
      <strong>🗂️ SIDEBAR:</strong> Visualizza tutte le carte disponibili<br>
      <strong>🃏 JOLLY:</strong> Sostituisce qualsiasi carta in attacco, ferma azione in difesa
    </div>
  </div>

  <div class="sidebar sidebar-left" id="defenseSidebar">
    <div class="sidebar-header">
      <h3 id="defenseSidebarTitle"></h3>
      <button class="btn-close-sidebar" type="button" onclick="toggleSidebar('defense')">✕</button>
    </div>
    <div class="sidebar-content" id="defenseSidebarContent"></div>
  </div>

  <div class="sidebar sidebar-right" id="attackSidebar">
    <div class="sidebar-header">
      <h3 id="attackSidebarTitle"></h3>
      <button class="btn-close-sidebar" type="button" onclick="toggleSidebar('attack')">✕</button>
    </div>
    <div class="sidebar-content" id="attackSidebarContent"></div>
  </div>

  <div class="modal" id="discardModal">
    <div class="modal-content">
      <button class="modal-close" type="button" onclick="closeDiscardModal()">✕</button>
      <h2>🗑️ CARTE SCARTATE</h2>
      <div class="discard-section">
        <h3 id="redDiscardTitle">🔴 SQUADRA ROSSA</h3>
        <div class="discard-grid" id="redDiscardGrid"></div>
      </div>
      <div class="discard-section">
        <h3 id="blueDiscardTitle">🔵 SQUADRA BLU</h3>
        <div class="discard-grid" id="blueDiscardGrid"></div>
      </div>
    </div>
  </div>

  <div class="modal" id="mazzoModal">
    <div class="modal-content">
      <button class="modal-close" type="button" onclick="closeMazzoModal()">✕</button>
      <h2>📚 MAZZO PESCATE</h2>
      <div class="discard-section">
        <h3 style="color: #FFD700;">CARTE DISPONIBILI</h3>
        <div class="discard-grid" id="mazzoGrid"></div>
      </div>
    </div>
  </div>
<script>
/* ========== STATE & COSTANTI ========== */
let gameState = {
  phase: 'waiting',
  step: 0,
  attackCardPlayed: null,
  defenseCardPlayed: null,
  lastPosition: null,
  redTeamName: '',
  blueTeamName: '',
  redTeamModule: '',
  blueTeamModule: '',
  firstAttacker: null,
  actionCount: 0,
  roleChanges: 0,
  redScore: 0,
  blueScore: 0,
  redCardsDiscarded: [],
  blueCardsDiscarded: [],
  goalScoredBy: null,
  mustReplayCard: null,
  penaltyInProgress: false,
  currentHalf: 1,
  halfTimeScore: { red: 0, blue: 0 },
  playedCardsOnField: [],
  hasDrawnThisAction: false,
  defenseCardsOnField: []
};

let attackHandRemaining = [];
let defenseHandRemaining = [];
let mazzoPescate = [];
let setupPhase = 1;

/* posizioni campo */
const FIELD_POSITIONS = {
  'difensore-Sx': { left: '15%', top: '20%' },
  'difensore-Cc': { left: '15%', top: '50%' },
  'difensore-Dx': { left: '15%', top: '80%' },
  'mediano-Sx': { left: '35%', top: '20%' },
  'mediano-Cc': { left: '35%', top: '50%' },
  'mediano-Dx': { left: '35%', top: '80%' },
  'centrocampista-Sx': { left: '65%', top: '20%' },
  'centrocampista-Cc': { left: '65%', top: '50%' },
  'centrocampista-Dx': { left: '65%', top: '80%' },
  'attaccante-Sx': { left: '85%', top: '20%' },
  'attaccante-Cc': { left: '85%', top: '50%' },
  'attaccante-Dx': { left: '85%', top: '80%' },
  'jolly-jolly': { left: '50%', top: '50%' }
};

/* confetti safe */
function launchConfetti() {
  const canvas = document.createElement('canvas');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  canvas.style.position = 'fixed';
  canvas.style.top = '0';
  canvas.style.left = '0';
  canvas.style.pointerEvents = 'none';
  canvas.style.zIndex = '9999';
  document.body.appendChild(canvas);

  const ctx = canvas.getContext('2d');
  const colors = ['#ff0000','#00ff00','#0000ff','#ffff00','#ff00ff','#00ffff','#ffa500','#ff1493'];
  const pieces = [];
  const N = 80;

  for (let i=0;i<N;i++){
    pieces.push({
      x: Math.random()*canvas.width,
      y: -20,
      w: Math.random()*8+4,
      h: Math.random()*6+3,
      c: colors[Math.floor(Math.random()*colors.length)],
      r: Math.random()*360,
      rs: Math.random()*10-5,
      vx: Math.random()*4-2,
      vy: Math.random()*3+2,
      g: 0.15
    });
  }

  function anim(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    let active=0;
    for(const p of pieces){
      if(p.y < canvas.height+50){
        active++;
        ctx.save();
        ctx.translate(p.x,p.y);
        ctx.rotate(p.r*Math.PI/180);
        ctx.fillStyle=p.c;
        ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h);
        ctx.restore();
        p.vy += p.g; p.x += p.vx; p.y += p.vy; p.r += p.rs;
      }
    }
    if(active>0) requestAnimationFrame(anim);
    else document.body.removeChild(canvas);
  }
  anim();
}

/* util */
function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
}

/* ========== LISTENER INIZIALI (Safari-safe) ========== */
const redInput  = document.getElementById('redTeamName');
const blueInput = document.getElementById('blueTeamName');

redInput.addEventListener('input', checkSetupPhase1);
blueInput.addEventListener('input', checkSetupPhase1);
redInput.addEventListener('change', checkSetupPhase1);
blueInput.addEventListener('change', checkSetupPhase1);

/* moduli */
document.getElementById('redTeamModule').addEventListener('change', checkSetupPhase2);
document.getElementById('blueTeamModule').addEventListener('change', checkSetupPhase2);

/* controlli abilitazione bottoni */
function checkSetupPhase1(){
  const n1 = redInput.value.trim();
  const n2 = blueInput.value.trim();
  const btn = document.getElementById('btnDistributeCards');
  btn.disabled = !(n1 && n2); // usare la property (Safari)
}

function checkSetupPhase2(){
  const m1 = document.getElementById('redTeamModule').value;
  const m2 = document.getElementById('blueTeamModule').value;
  const btn = document.getElementById('btnStartGame');
  btn.disabled = !(m1 && m2);
}

/* ========== MAZZO ========== */
function creaMazzoCompleto(){
  const mazzo = [];
  const ruoli = ['difensore','mediano','centrocampista','attaccante'];
  const pos = ['Dx','Cc','Sx'];
  const icone = { difensore:'🛡️', mediano:'🎯', centrocampista:'⚙️', attaccante:'⚔️' };

  ruoli.forEach(r=>{
    pos.forEach(p=>{
      for(let i=0;i<5;i++){
        mazzo.push({ tipo:r, pos:p, icona:icone[r] });
      }
    });
  });

  const difesa = [
    {tipo:'contrasto-vincente', icona:'✅', count:2},
    {tipo:'contropiede',        icona:'⚡', count:2},
    {tipo:'contrasto-perdente', icona:'❌', count:2},
    {tipo:'parata',             icona:'🧤', count:2},
    {tipo:'fallo-tattico',      icona:'🟨', count:2},
    {tipo:'fallo-laterale',     icona:'↩️', count:2},
    {tipo:'fallo-rigore',       icona:'🔴', count:2},
    {tipo:'sostituzione',       icona:'🔄', count:2},
    {tipo:'calcio-angolo',      icona:'🚩', count:2}, /* 🔧 uniformato: calcio-angolo */
    {tipo:'fuorigioco',         icona:'🚫', count:2}
  ];
  difesa.forEach(c => { for(let i=0;i<c.count;i++) mazzo.push({ tipo:c.tipo, icona:c.icona }); });

  for(let i=0;i<2;i++) mazzo.push({ tipo:'jolly', icona:'🃏' });
  for(let i=0;i<2;i++) mazzo.push({ tipo:'var',   icona:'📹' });

  return mazzo;
}

/* ========== DISTRIBUZIONE CARTE ========== */
document.getElementById('btnDistributeCards').addEventListener('click', function(){
  gameState.redTeamName  = redInput.value.trim();
  gameState.blueTeamName = blueInput.value.trim();

  const full = creaMazzoCompleto();
  const attacco = full.filter(c => ['difensore','mediano','centrocampista','attaccante'].includes(c.tipo));
  const difesa  = full.filter(c => !['difensore','mediano','centrocampista','attaccante'].includes(c.tipo));

  shuffle(attacco); shuffle(difesa);

  const a1 = attacco.slice(0,15);
  const a2 = attacco.slice(15,30);
  const aR = attacco.slice(30);

  const d1 = difesa.slice(0,6);
  const d2 = difesa.slice(6,12);
  const dR = difesa.slice(12);

  attackHandRemaining  = [...a1, ...d1];
  defenseHandRemaining = [...a2, ...d2];

  mazzoPescate = [...aR, ...dR];
  shuffle(mazzoPescate);

  showModuleSelectionPhase();
});

/* ========== PHASE 2: scelta modulo, anteprima mani ========== */
function showModuleSelectionPhase(){
  setupPhase = 2;

  document.getElementById('redTeamName').style.display = 'none';
  document.getElementById('blueTeamName').style.display = 'none';
  document.querySelector('.team-setup:nth-child(1) .team-setup-label').style.display='none';
  document.querySelector('.team-setup:nth-child(2) .team-setup-label').style.display='none';

  document.getElementById('redTeamNameHeader').style.display = 'block';
  document.getElementById('blueTeamNameHeader').style.display = 'block';

  document.getElementById('redTeamNameDisplay').textContent  = gameState.redTeamName;
  document.getElementById('blueTeamNameDisplay').textContent = gameState.blueTeamName;
  document.getElementById('redTeamNameDisplay').style.display  = 'block';
  document.getElementById('blueTeamNameDisplay').style.display = 'block';

  document.getElementById('btnViewRedCards').style.display  = 'block';
  document.getElementById('btnViewBlueCards').style.display = 'block';
  document.getElementById('redNameBtn').textContent  = gameState.redTeamName;
  document.getElementById('blueNameBtn').textContent = gameState.blueTeamName;

  document.getElementById('redTeamModule').style.display  = 'block';
  document.getElementById('blueTeamModule').style.display = 'block';

  document.getElementById('btnDistributeCards').style.display = 'none';
  document.getElementById('btnStartGame').style.display       = 'block';
}

/* anteprima mani in fase setup */
function openSidebarSetup(player){
  renderSidebar(player, true);
  const id = (player==='defense') ? 'defenseSidebar' : 'attackSidebar';
  document.getElementById(id).classList.add('open');
}

/* ========== AVVIO PARTITA ========== */
document.getElementById('btnStartGame').addEventListener('click', function(){
  gameState.redTeamModule  = document.getElementById('redTeamModule').value;
  gameState.blueTeamModule = document.getElementById('blueTeamModule').value;

  gameState.firstAttacker = Math.random()<0.5 ? 'red' : 'blue';

  document.getElementById('redTeamHeader').textContent  = gameState.redTeamName;
  document.getElementById('blueTeamHeader').textContent = gameState.blueTeamName;

  updateSidebarTitles();
  setActivePlayer('attack');

  const attackerName = (gameState.firstAttacker==='red') ? gameState.redTeamName : gameState.blueTeamName;
  document.getElementById('actionStatus').textContent = `${attackerName} inizia! Clicca "INIZIA AZIONE"`;

  document.getElementById('setupPage').classList.add('hidden');
  document.getElementById('gameContainer').classList.add('visible');
});

/* titoli sidebar coerenti con chi attacca per primo */
function updateSidebarTitles(){
  if(gameState.firstAttacker==='blue'){
    document.getElementById('defenseSidebarTitle').textContent = `MANO ${gameState.redTeamName.toUpperCase()}`;
    document.getElementById('attackSidebarTitle').textContent  = `MANO ${gameState.blueTeamName.toUpperCase()}`;
  } else {
    document.getElementById('defenseSidebarTitle').textContent = `MANO ${gameState.blueTeamName.toUpperCase()}`;
    document.getElementById('attackSidebarTitle').textContent  = `MANO ${gameState.redTeamName.toUpperCase()}`;
  }
}

/* apertura/chiusura sidebar + render */
function toggleSidebar(player){
  const a = document.getElementById('attackSidebar');
  const d = document.getElementById('defenseSidebar');

  if(player==='attack'){
    const isOpen = a.classList.contains('open');
    a.classList.toggle('open');
    d.classList.remove('open');
    if(!isOpen) renderSidebar('attack');
  } else {
    const isOpen = d.classList.contains('open');
    d.classList.toggle('open');
    a.classList.remove('open');
    if(!isOpen) renderSidebar('defense');
  }
}

/* render mano nella/e sidebar (viewOnly in fase setup) */
function renderSidebar(player, viewOnly=false){
  const hand = (player==='attack') ? attackHandRemaining : defenseHandRemaining;
  const contentId = (player==='attack') ? 'attackSidebarContent' : 'defenseSidebarContent';
  const content = document.getElementById(contentId);

  const isAtt = c => ['difensore','mediano','centrocampista','attaccante'].includes(c.tipo);
  const isDef = c => ['contrasto-vincente','contropiede','contrasto-perdente','parata','fallo-tattico','fallo-laterale','fallo-rigore','calcio-angolo','fuorigioco','sostituzione'].includes(c.tipo);
  const isSpec= c => ['jolly','var'].includes(c.tipo);

  const attacco = hand.filter(isAtt);
  const difesa  = hand.filter(isDef);
  const speciali= hand.filter(isSpec);

  let html='';

  function section(tit, arr){
    if(arr.length===0) return '';
    return `<div class="hand-section"><h4>${tit} (${arr.length})</h4><div class="hand-cards-grid">`+
      arr.map(c => createSidebarCard(c, hand.indexOf(c), player, viewOnly)).join('') +
      `</div></div>`;
  }

  if(player==='defense'){
    html += section('🛡️ CARTE DIFESA', difesa);
    html += section('✨ CARTE SPECIALI', speciali);
    html += section('⚔️ CARTE ATTACCO', attacco);
  } else {
    html += section('⚔️ CARTE ATTACCO', attacco);
    html += section('✨ CARTE SPECIALI', speciali);
    html += section('🛡️ CARTE DIFESA', difesa);
  }

  content.innerHTML = html;
}

/* card nella sidebar */
function createSidebarCard(card, index, player, viewOnly=false){
  const isPlayable = !viewOnly && checkIfPlayable(card, player);
  const playableClass = isPlayable ? 'playable' : '';
  const onclick = isPlayable ? `onclick="playCardFromSidebar('${player}', ${index})"` : '';

  const posMap = { 'Dx':'DESTRO', 'Cc':'CENTRALE', 'Sx':'SINISTRO' };

  if(card.pos){
    return `<div class="carta in-sidebar ${card.tipo} ${playableClass}" ${onclick}>
      <div class="carta-icona">${card.icona}</div>
      <div class="carta-nome">${card.tipo.toUpperCase()}</div>
      <div class="carta-posizione">${posMap[card.pos]}</div>
    </div>`;
  } else {
    return `<div class="carta in-sidebar ${card.tipo} ${playableClass}" ${onclick}>
      <div class="carta-icona">${card.icona}</div>
      <div class="carta-nome">${card.tipo.replace(/-/g,' ').toUpperCase()}</div>
    </div>`;
  }
}
</script>
<script>
/* === PLAY da sidebar & regole giocabilità === */

/* click su carta nella sidebar */
function playCardFromSidebar(player, cardIndex){
  const hand = (player==='attack') ? attackHandRemaining : defenseHandRemaining;
  const card = hand[cardIndex];

  if(!card) return;

  /* gestione Jolly */
  if(card.tipo==='jolly'){
    if(player==='attack' && gameState.phase==='attack-turn'){
      playJollyAttack();
    } else if(player==='defense' && gameState.phase==='defense-turn'){
      playJollyDefense();
    }
    return;
  }

  /* gestione VAR solo quando il goal è in revisione */
  if(card.tipo==='var' && gameState.phase==='goal-scored'){
    useVAR();
    return;
  }

  /* normale carta attacco/difesa */
  if(player==='attack' && gameState.phase==='attack-turn'){
    // per attacco ho sempre pos (Dx/Cc/Sx)
    const posShort = (card.pos || '').toUpperCase();
    playAttackCard(card.tipo, posShortToLabel(posShort), posShort);
    return;
  }
  if(player==='defense' && gameState.phase==='defense-turn'){
    const cardType = card.tipo;
    const cardName = normalizeCardName(cardType); // es. "contrasto-vincente" -> "Contrasto Vincente"
    const stops = ['contrasto-vincente','contropiede','parata','fuorigioco'].includes(cardType);
    playDefenseCard(cardName, stops);
    return;
  }
}

/* jolly attacco */
function playJollyAttack(){
  gameState.attackCardPlayed = { tipo:'jolly', posizione:'JOLLY', posShort:'jolly', icona:'🃏' };
  gameState.playedCardsOnField.push({ tipo:'jolly', pos:'jolly' });
  gameState.lastPosition = 'jolly';
  gameState.phase = 'defense-turn';
  gameState.mustReplayCard = null;

  removeCardFromHand('attack','jolly');

  const defenderName = (gameState.firstAttacker==='red') ? gameState.blueTeamName : gameState.redTeamName;
  document.getElementById('actionStatus').textContent = `🃏 Jolly giocato! ${defenderName}: Rispondi o lascia proseguire`;
  showDefenseCards();
  setActivePlayer('defense');
  renderFieldCards();
}

/* jolly difesa */
function playJollyDefense(){
  gameState.defenseCardPlayed = { name:'Jolly', stops:true };
  removeCardFromHand('defense','jolly');
  showDefenseCardOnField('Jolly','jolly');
  setTimeout(()=>{ switchRoles('Jolly! Azione fermata', 0, null); }, 1500);
}

/* util label posizione */
function posShortToLabel(p){
  const map = { 'DX':'DESTRO', 'CC':'CENTRALE', 'SX':'SINISTRO', 'JOLLY':'JOLLY' };
  return map[p] || p;
}

/* è giocabile? (attacco/difesa/var/jolly) */
function checkIfPlayable(card, player){
  if(gameState.phase==='waiting' || gameState.phase==='ended') return false;

  if(card.tipo==='jolly'){
    if(player==='attack' && gameState.phase==='attack-turn') return true;
    if(player==='defense' && gameState.phase==='defense-turn') return true;
    return false;
  }

  if(card.tipo==='var'){
    return gameState.phase==='goal-scored' && player==='defense';
  }

  if(player==='attack' && gameState.phase==='attack-turn'){
    // se devo rigiocare una carta specifica (rimessa/angolo)
    if(gameState.mustReplayCard){
      const t = gameState.mustReplayCard.tipo;
      const p = gameState.mustReplayCard.pos; // può essere null se prima era jolly
      if(p===null) return card.tipo===t;
      return (card.tipo===t && card.pos===p);
    }
    const roles = ['difensore','mediano','centrocampista','attaccante'];
    const currentRole = roles[gameState.step];
    if(card.tipo!==currentRole) return false;
    if(!gameState.lastPosition) return true;
    return isPositionValid(card.pos, gameState.lastPosition);
  }

  if(player==='defense' && gameState.phase==='defense-turn'){
    return isDefenseCardPlayable(card.tipo);
  }

  return false;
}

/* movimento valido tra posizioni */
function isPositionValid(nextPos, lastPos){
  if(lastPos==='jolly') return true;
  const valid = { 'Dx':['Cc','Dx'], 'Cc':['Sx','Cc','Dx'], 'Sx':['Cc','Sx'] };
  return (valid[lastPos]||[]).includes(nextPos);
}

/* normalizza nome carta difesa per l’UI */
function normalizeCardName(tipo){
  // uniformiamo l’incongruenza "calcio-angolo" vs "calcio-dangolo"
  const t = tipo.replace('calcio-dangolo','calcio-angolo');
  return t.split('-').map(w=>w.charAt(0).toUpperCase()+w.slice(1)).join(' ');
}

/* logica carte difensive giocabili per step */
function isDefenseCardPlayable(tipo){
  const t = tipo.replace('calcio-dangolo','calcio-angolo'); // fix coerenza
  const step = gameState.step;

  const universali = ['contrasto-vincente','contrasto-perdente','contropiede','fallo-tattico','sostituzione'];
  if(universali.includes(t)) return true;

  if(t==='fallo-laterale'){
    if(!gameState.attackCardPlayed) return false;
    const pos = gameState.attackCardPlayed.posShort;
    return (pos==='Dx' || pos==='Sx' || pos==='jolly');
  }

  if(t==='calcio-angolo'){
    if(step!==3) return false; // solo in attacco su ultima carta
    if(!gameState.attackCardPlayed) return false;
    const pos = gameState.attackCardPlayed.posShort;
    return (pos==='Dx' || pos==='Sx' || pos==='jolly');
  }

  if(step===3) return ['parata','fuorigioco','fallo-rigore'].includes(t);

  return false;
}
</script>
<script>
/* === Render carte su campo & play attacco === */

/* HTML di una carta da campo */
function createFieldCardHTML(tipo, pos, isPlayed){
  const icone = { difensore:'🛡️', mediano:'🎯', centrocampista:'⚙️', attaccante:'⚔️', jolly:'🃏' };
  const posMap = { 'Dx':'DESTRO', 'Cc':'CENTRALE', 'Sx':'SINISTRO', 'jolly':'JOLLY' };
  const playedClass = isPlayed ? 'played' : 'playable';

  if(tipo==='jolly'){
    return `<div class="carta ${tipo} ${playedClass}">
      <div class="carta-icona">${icone[tipo]}</div>
      <div class="carta-nome">JOLLY</div>
    </div>`;
  }
  return `<div class="carta ${tipo} ${playedClass}">
    <div class="carta-icona">${icone[tipo]}</div>
    <div class="carta-nome">${tipo.toUpperCase()}</div>
    <div class="carta-posizione">${posMap[pos]}</div>
  </div>`;
}

/* mette una carta ATTACCO in una certa posizione del campo */
function createCardOnField(tipo, pos, isPlayed=false){
  const fieldCards = document.getElementById('fieldCards');
  const key = `${tipo}-${pos}`;
  const position = FIELD_POSITIONS[key];
  if(!position) return;

  const cardDiv = document.createElement('div');
  cardDiv.className = 'field-position';
  cardDiv.style.left = position.left;
  cardDiv.style.top  = position.top;
  cardDiv.style.transform = 'translate(-50%, -50%)';
  cardDiv.style.position  = 'absolute';
  cardDiv.innerHTML = createFieldCardHTML(tipo, pos, isPlayed);

  if(!isPlayed){
    cardDiv.onclick = () => playAttackCardFromField(tipo, pos);
  }
  fieldCards.appendChild(cardDiv);
}

/* overlay carta DIFESA vicino all’ultima carta attacco giocata */
function createDefenseCardOnField(cardType, cardName, attackCardRef, isPlayed=true){
  const fieldCards = document.getElementById('fieldCards');
  const lastPos = FIELD_POSITIONS[`${attackCardRef.tipo}-${attackCardRef.pos}`];
  if(!lastPos) return;

  const offsetLeft = parseFloat(lastPos.left) + 3;
  const offsetTop  = parseFloat(lastPos.top) - 3;

  const icons = {
    'contrasto-vincente':'✅','contropiede':'⚡','contrasto-perdente':'❌','parata':'🧤','fallo-tattico':'🟨',
    'fallo-laterale':'↩️','fallo-rigore':'🔴','calcio-angolo':'🚩','fuorigioco':'🚫','sostituzione':'🔄','jolly':'🃏'
  };
  const icon = icons[cardType] || '🛡️';
  const playedClass = isPlayed ? 'played' : '';

  const wrap = document.createElement('div');
  wrap.className = 'field-position defense-card-overlay';
  wrap.style.position = 'absolute';
  wrap.style.left = `${offsetLeft}%`;
  wrap.style.top  = `${offsetTop}%`;
  wrap.style.transform = 'translate(-50%, -50%)';
  wrap.style.zIndex = '15';
  wrap.innerHTML = `
    <div class="carta ${cardType} ${playedClass}">
      <div class="carta-icona">${icon}</div>
      <div class="carta-nome">${cardName.replace(/-/g,' ').toUpperCase()}</div>
    </div>
  `;
  fieldCards.appendChild(wrap);
}

/* click su carta attacco mostrata sul campo */
function playAttackCardFromField(tipo, pos){
  const map = { 'Dx':'DESTRO','Cc':'CENTRALE','Sx':'SINISTRO' };
  playAttackCard(tipo, map[pos], pos);
}

/* gioca una carta di ATTACCO (da sidebar o da campo) */
function playAttackCard(tipo, posizione, posShort){
  const icone = { difensore:'🛡️', mediano:'🎯', centrocampista:'⚙️', attaccante:'⚔️' };

  gameState.attackCardPlayed = {
    tipo, posizione, posShort, icona: icone[tipo]
  };

  gameState.playedCardsOnField.push({ tipo, pos: posShort });
  gameState.lastPosition   = posShort;
  gameState.phase          = 'defense-turn';
  gameState.mustReplayCard = null;

  removeCardFromHand('attack', tipo, posShort);

  const defenderName = (gameState.firstAttacker==='red') ? gameState.blueTeamName : gameState.redTeamName;
  document.getElementById('actionStatus').textContent = `🛡️ ${defenderName}: Rispondi alla carta ${tipo.toUpperCase()}`;
  showDefenseCards();
  setActivePlayer('defense');
  renderFieldCards();
}

/* rendering completo delle carte sul campo in base allo stato */
function renderFieldCards(){
  const fieldCards = document.getElementById('fieldCards');
  fieldCards.innerHTML = '';

  // rimetto tutte le carte attacco già giocate
  gameState.playedCardsOnField.forEach(p => createCardOnField(p.tipo, p.pos, true));

  // rimetto overlay difesa già giocati
  gameState.defenseCardsOnField.forEach(d => createDefenseCardOnField(d.type, d.name, d.attackCardRef, true));

  // se non è turno attacco o rigore, non propongo scelte
  if(gameState.phase!=='attack-turn' && gameState.phase!=='penalty-kick') return;

  // RIGORE: mostrati solo attaccanti (o bottone pesca)
  if(gameState.phase==='penalty-kick'){
    const hand = attackHandRemaining;
    const att = hand.filter(c => c.tipo==='attaccante');
    if(att.length>0){
      att.forEach(c=>{
        const key = `attaccante-${c.pos}`;
        const position = FIELD_POSITIONS[key];
        if(position){
          const cardDiv = document.createElement('div');
          cardDiv.className = 'field-position';
          cardDiv.style.position = 'absolute';
          cardDiv.style.left = position.left;
          cardDiv.style.top  = position.top;
          cardDiv.style.transform = 'translate(-50%, -50%)';
          cardDiv.innerHTML = createFieldCardHTML('attaccante', c.pos, false);
          cardDiv.onclick = () => playPenaltyCard('attaccante', c.pos);
          fieldCards.appendChild(cardDiv);
        }
      });
    } else {
      const drawBtn = document.createElement('button');
      drawBtn.className = 'btn-draw-card';
      drawBtn.type = 'button';
      drawBtn.onclick = () => pescaCartaPerRigore();
      drawBtn.innerHTML = '<div style="font-size:24px;">📚</div><div style="font-size:8px; margin-top:4px;">PESCA<br>CARTA</div>';
      fieldCards.appendChild(drawBtn);
    }
    return;
  }

  // TURNO ATTACCO normale: propongo solo le posizioni valide per il ruolo corrente
  const hand = attackHandRemaining;

  // se mazzo finito e nessuna giocabile → fine tempo/check
  if(mazzoPescate.length===0 && !hasPlayableCards()){ checkEndOfHalf(); return; }

  let hasPlayable = false;

  if(gameState.mustReplayCard){
    const { tipo, pos } = gameState.mustReplayCard;
    if(pos===null){
      ['Sx','Cc','Dx'].forEach(p=>{
        if(hand.some(c => c.tipo===tipo && c.pos===p)){ createCardOnField(tipo, p, false); hasPlayable=true; }
      });
    } else {
      if(hand.some(c => c.tipo===tipo && c.pos===pos)){ createCardOnField(tipo, pos, false); hasPlayable=true; }
    }
  } else {
    const roles = ['difensore','mediano','centrocampista','attaccante'];
    const currentRole = roles[gameState.step];
    ['Sx','Cc','Dx'].forEach(p=>{
      const has = hand.some(c => c.tipo===currentRole && c.pos===p);
      if(has){
        const ok = !gameState.lastPosition || isPositionValid(p, gameState.lastPosition);
        if(ok){ createCardOnField(currentRole, p, false); hasPlayable = true; }
      }
    });
  }

  if(!hasPlayable && mazzoPescate.length>0 && !gameState.hasDrawnThisAction){
    const drawBtn = document.createElement('button');
    drawBtn.className = 'btn-draw-card';
    drawBtn.type = 'button';
    drawBtn.onclick = () => pescaCartaGiocatore('attack');
    drawBtn.innerHTML = '<div style="font-size:24px;">📚</div><div style="font-size:8px; margin-top:4px;">PESCA<br>CARTA</div>';
    fieldCards.appendChild(drawBtn);
  } else if(!hasPlayable && (mazzoPescate.length===0 || gameState.hasDrawnThisAction)){
    checkEndOfHalf();
  }
}

/* utility: c'è almeno una carta attaccabile? */
function hasPlayableCards(){
  const hand = attackHandRemaining;

  if(gameState.mustReplayCard){
    const { tipo, pos } = gameState.mustReplayCard;
    if(pos===null) return hand.some(c => c.tipo===tipo);
    return hand.some(c => c.tipo===tipo && c.pos===pos);
  }

  const roles = ['difensore','mediano','centrocampista','attaccante'];
  const currentRole = roles[gameState.step];
  return hand.some(c=>{
    if(c.tipo!==currentRole) return false;
    if(!gameState.lastPosition) return true;
    return isPositionValid(c.pos, gameState.lastPosition);
  });
}
</script>
<script>
/* === UI Difesa, play carta difesa, avanzamento turni === */

/* mostra le carte difesa disponibili (versione compatta in alto) */
function showDefenseCards(){
  const hand = defenseHandRemaining;
  const step = gameState.step;
  const canFalloLaterale = isDefenseCardPlayable('fallo-laterale');
  const canCalcioAngolo  = isDefenseCardPlayable('calcio-angolo');

  const el = document.getElementById('defenseHand');
  let html = '';

  function add(type, label, stops){
    if(hand.some(c=>c.tipo===type)){
      html += `<div class="carta ${type}" onclick="playDefenseCard('${label}', ${stops})">
        <div class="carta-icona">${defIcon(type)}</div>
        <div class="carta-nome">${label.toUpperCase()}</div>
      </div>`;
    }
  }

  add('contrasto-vincente','Contrasto Vincente', true);
  add('contrasto-perdente','Contrasto Perdente', false);
  add('contropiede','Contropiede', true);
  add('fallo-tattico','Fallo Tattico', false);
  add('sostituzione','Sostituzione', false);

  if(canFalloLaterale) add('fallo-laterale','Fallo Laterale', false);

  if(step===3){
    add('parata','Parata', true);
    add('fuorigioco','Fuorigioco', true);
    if(canCalcioAngolo) add('calcio-angolo','Calcio d\'Angolo', false);
    add('fallo-rigore','Fallo Rigore', false);
  }

  html += '<button class="btn" type="button" onclick="skipDefense()" style="width:clamp(60px,6vw,80px);height:clamp(60px,6vw,80px);border-radius:50%;font-size:clamp(30px,3vw,40px);padding:0;">↻</button>';
  el.innerHTML = html;
}

function defIcon(t){
  const m = {'contrasto-vincente':'✅','contrasto-perdente':'❌','contropiede':'⚡','parata':'🧤','fallo-tattico':'🟨','fallo-laterale':'↩️','fallo-rigore':'🔴','calcio-angolo':'🚩','fuorigioco':'🚫','sostituzione':'🔄','jolly':'🃏'};
  return m[t] || '🛡️';
}

/* gioca una carta di DIFESA */
function playDefenseCard(cardName, stopsAction){
  gameState.defenseCardPlayed = { name: cardName, stops: stopsAction };
  // normalizzo type es: "Calcio d'Angolo" -> "calcio-angolo"
  const cardType = cardName.toLowerCase().replace(/\s+/g,'-').replace(/'/g,'').replace('calcio-dangolo','calcio-angolo');

  removeCardFromHand('defense', cardType);
  showDefenseCardOnField(cardType, cardName);

  const draws = ['contrasto-perdente','fallo-tattico','sostituzione'];
  const didDraw = draws.includes(cardType);
  if(didDraw) pescaCartaDifesa();

  const extraDelay = didDraw ? 5000 : 0;

  setTimeout(()=>{
    if(cardType==='contrasto-vincente'){
      setTimeout(()=> switchRoles('Contrasto Vincente!', 0, null), 1500);
      return;
    }
    if(cardType==='contropiede'){
      const s = gameState.step;
      const p = gameState.lastPosition;
      setTimeout(()=> switchRoles('Contropiede!', s, p), 1500);
      return;
    }
    if(cardType==='parata'){
      setTimeout(()=> switchRoles('Parata! Goal annullato', 0, null), 1500);
      return;
    }
    if(cardType==='fuorigioco'){
      setTimeout(()=> switchRoles('Fuorigioco! Azione annullata', 0, null), 1500);
      return;
    }
    if(cardType==='fallo-rigore'){
      setTimeout(()=> handlePenaltyKick(), 1500);
      return;
    }
    if(cardType==='fallo-laterale' || cardType==='calcio-angolo'){
      const wasJolly = gameState.attackCardPlayed.posShort === 'jolly';
      const toReplay = { tipo: gameState.attackCardPlayed.tipo, pos: wasJolly ? null : gameState.attackCardPlayed.posShort };

      const hasCard = attackHandRemaining.some(c =>
        c.tipo==='jolly' || (wasJolly ? c.tipo===toReplay.tipo : (c.tipo===toReplay.tipo && c.pos===toReplay.pos))
      );
      if(!hasCard){
        setTimeout(()=> switchRoles('Carta mancante!', 0, null), 1500);
        return;
      }

      setTimeout(()=>{
        gameState.phase = 'attack-turn';
        gameState.lastPosition = wasJolly ? null : toReplay.pos;
        gameState.attackCardPlayed = null;
        gameState.defenseCardPlayed = null;
        gameState.mustReplayCard = toReplay;

        const attackerName = (gameState.firstAttacker==='red') ? gameState.redTeamName : gameState.blueTeamName;
        const roles = ['DIFENSORE','MEDIANO','CENTROCAMPISTA','ATTACCANTE'];
        const cardTypeName = (cardType==='fallo-laterale') ? 'Fallo Laterale' : 'Calcio d\'Angolo';
        const posText = wasJolly ? ' (qualsiasi posizione)' : '';
        document.getElementById('actionStatus').textContent =
          `↩️ ${cardTypeName}! ${attackerName} deve rigiocare ${roles[gameState.step]}${posText}`;

        renderFieldCards();
        clearDefenseHand();
        setActivePlayer('attack');
        if(document.getElementById('attackSidebar').classList.contains('open')) renderSidebar('attack');
      },1500);
      return;
    }

    /* default: o blocca, o lascia proseguire */
    if(stopsAction) endAction(false);
    else setTimeout(()=> continueAction(), 1500);
  }, extraDelay);
}

/* rimuove la carta dalla mano e aggiorna scarti + sidebar */
function removeCardFromHand(player, tipo, pos=null){
  const hand = (player==='attack') ? attackHandRemaining : defenseHandRemaining;
  const idx = hand.findIndex(c => pos ? (c.tipo===tipo && c.pos===pos) : (c.tipo===tipo));
  if(idx===-1) return;

  const card = hand[idx];
  const isRedDiscarding = (player==='attack' && gameState.firstAttacker==='red') ||
                          (player==='defense' && gameState.firstAttacker==='blue');
  if(isRedDiscarding) gameState.redCardsDiscarded.push(card);
  else gameState.blueCardsDiscarded.push(card);

  hand.splice(idx,1);
  updateTrashButton();

  const sidebar = (player==='attack') ? document.getElementById('attackSidebar') : document.getElementById('defenseSidebar');
  if(sidebar.classList.contains('open')) renderSidebar(player);
}

/* pesca carta per la difesa (effetti che prevedono pesca) */
function pescaCartaDifesa(){
  if(mazzoPescate.length===0) return;
  const carta = mazzoPescate.pop();
  defenseHandRemaining.push(carta);

  const defenderName = (gameState.firstAttacker==='red') ? gameState.blueTeamName : gameState.redTeamName;
  const nome = carta.pos ? `${carta.tipo.toUpperCase()} ${carta.pos.toUpperCase()}` : carta.tipo.toUpperCase();

  const el = document.getElementById('actionStatus');
  el.textContent = `${el.textContent} | 🎴 ${defenderName} pesca: ${nome}`;

  if(document.getElementById('defenseSidebar').classList.contains('open')) renderSidebar('defense');
}

/* passa la difesa (non gioca alcuna carta) */
function skipDefense(){
  gameState.defenseCardPlayed = null;
  setTimeout(()=> continueAction(), 800);
}

/* continua l’azione (prossimo ruolo) */
function continueAction(){
  gameState.step++;
  if(gameState.step>=4){ endAction(true); return; }

  gameState.phase='attack-turn';
  gameState.attackCardPlayed=null;
  gameState.defenseCardPlayed=null;

  const roles = ['DIFENSORE','MEDIANO','CENTROCAMPISTA','ATTACCANTE'];
  const attackerName = (gameState.firstAttacker==='red') ? gameState.redTeamName : gameState.blueTeamName;
  document.getElementById('actionStatus').textContent = `⚔️ ${attackerName}: Gioca un ${roles[gameState.step]}`;

  renderFieldCards();
  clearDefenseHand();
  setActivePlayer('attack');
}

/* fine azione: goal o difesa riuscita (con eventuale VAR) */
function endAction(isGoal){
  const attackerName = (gameState.firstAttacker==='red') ? gameState.redTeamName : gameState.blueTeamName;
  const defenderName = (gameState.firstAttacker==='red') ? gameState.blueTeamName : gameState.redTeamName;

  if(isGoal){
    if(gameState.firstAttacker==='red'){ gameState.redScore++; gameState.goalScoredBy='red'; }
    else { gameState.blueScore++; gameState.goalScoredBy='blue'; }
  } else {
    // nel tuo gioco l’esito "difesa riuscita" incrementa il punteggio del difendente
    if(gameState.firstAttacker==='red'){ gameState.blueScore++; gameState.goalScoredBy='blue'; }
    else { gameState.redScore++; gameState.goalScoredBy='red'; }
  }

  document.getElementById('redScore').textContent  = gameState.redScore;
  document.getElementById('blueScore').textContent = gameState.blueScore;

  if(isGoal){
    launchConfetti();
    document.getElementById('actionStatus').innerHTML = `
      <div class="result-banner">⚽ GOOOOOL! ⚽</div>
      <div style="margin-top:10px;font-size:.9em;">${attackerName} ha completato la sequenza!</div>
      <div style="margin-top:8px;font-size:.85em;color:white;">
        ${gameState.redTeamName}: ${gameState.redScore} Goal - ${gameState.blueTeamName}: ${gameState.blueScore} Goal
      </div>`;
  } else {
    document.getElementById('actionStatus').innerHTML = `
      <div class="result-banner fail">🛡️ DIFESA RIUSCITA! 🛡️</div>
      <div style="margin-top:10px;font-size:.9em;">${defenderName} ha fermato l'azione!</div>
      <div style="margin-top:8px;font-size:.85em;color:white;">
        ${gameState.redTeamName}: ${gameState.redScore} Goal - ${gameState.blueTeamName}: ${gameState.blueScore} Goal
      </div>`;
  }

  setTimeout(()=>{
    const defenderHand = (gameState.firstAttacker==='red') ? defenseHandRemaining : attackHandRemaining;
    const hasVAR = defenderHand.some(c=>c.tipo==='var');
    if(hasVAR) showVARDecision();
    else proceedAfterGoal();
  }, 2000);
}

/* prompt VAR se disponibile */
function showVARDecision(){
  gameState.phase='goal-scored';
  const defenderName = (gameState.firstAttacker==='red') ? gameState.blueTeamName : gameState.redTeamName;

  document.getElementById('actionStatus').innerHTML = `
    <div class="result-banner">📹 DECISIONE VAR</div>
    <div style="margin-top:10px;font-size:.9em;">${defenderName}, hai carte VAR disponibili!</div>
    <div style="margin-top:15px;display:flex;gap:15px;justify-content:center;">
      <button class="btn" type="button" onclick="useVAR()" style="font-size:1em;padding:12px 24px;">✅ USA VAR<br><span style="font-size:.7em;">Annulla goal</span></button>
      <button class="btn" type="button" onclick="skipVAR()" style="font-size:1em;padding:12px 24px;background:linear-gradient(135deg,#9E9E9E,#757575);">❌ NON USARE<br><span style="font-size:.7em;">Accetta goal</span></button>
    </div>`;

  if(document.getElementById('defenseSidebar').classList.contains('open')) renderSidebar('defense');
  if(document.getElementById('attackSidebar').classList.contains('open'))  renderSidebar('attack');
}

/* applica VAR: toglie goal e scarta carta */
function useVAR(){
  if(gameState.goalScoredBy==='red') gameState.redScore--;
  else gameState.blueScore--;

  document.getElementById('redScore').textContent  = gameState.redScore;
  document.getElementById('blueScore').textContent = gameState.blueScore;

  const isRedDefending = (gameState.firstAttacker==='blue');
  removeCardFromHand(isRedDefending ? 'attack' : 'defense', 'var');

  const defenderName = (gameState.firstAttacker==='red') ? gameState.blueTeamName : gameState.redTeamName;
  document.getElementById('actionStatus').innerHTML = `
    <div class="result-banner">📹 VAR! GOAL ANNULLATO</div>
    <div style="margin-top:10px;font-size:.9em;">${defenderName} usa VAR e annulla il goal!</div>`;

  setTimeout(()=> switchRoles('VAR! Goal annullato', 0, null), 2000);
}

/* non usare VAR */
function skipVAR(){
  gameState.phase='waiting';
  proceedAfterGoal();
}

/* dopo (non) VAR: fine o cambio possesso */
function proceedAfterGoal(){
  if(gameState.roleChanges >= 2){
    setTimeout(()=>{
      gameState.phase='ended';
      document.getElementById('attackArea').classList.add('disabled');
      document.getElementById('defenseArea').classList.add('disabled');
      document.getElementById('actionStatus').innerHTML = `
        <div class="result-banner">🏁 FINE PARTITA 🏁</div>
        <div style="margin-top:10px;font-size:.9em;">Partita terminata dopo ${gameState.roleChanges} cambi ruolo</div>
        <div style="margin-top:8px;font-size:.85em;color:white;">
          PUNTEGGIO FINALE:<br>
          ${gameState.redTeamName}: ${gameState.redScore} Goal<br>
          ${gameState.blueTeamName}: ${gameState.blueScore} Goal
        </div>`;
    }, 500);
  } else {
    setTimeout(()=> invertRoles(), 500);
  }
}

/* UI util */
function clearDefenseHand(){
  document.getElementById('defenseHand').innerHTML = '<div style="color:white;font-size:.8em;text-align:center;">In attesa...</div>';
}
</script>
<script>
/* === Avvio azione (turno attacco) === */
function startAction(){
  gameState.phase = 'attack-turn';
  gameState.step = 0;
  gameState.attackCardPlayed = null;
  gameState.defenseCardPlayed = null;
  gameState.lastPosition = null;
  gameState.mustReplayCard = null;
  gameState.playedCardsOnField = [];
  gameState.hasDrawnThisAction = false;
  gameState.defenseCardsOnField = [];

  const attackerName = (gameState.firstAttacker==='red') ? gameState.redTeamName : gameState.blueTeamName;
  document.getElementById('actionStatus').textContent = `⚔️ ${attackerName}: Gioca un DIFENSORE`;

  renderFieldCards();
  setActivePlayer('attack');

  document.getElementById('defenseSidebar').classList.remove('open');
  if(document.getElementById('attackSidebar').classList.contains('open')) renderSidebar('attack');
}

/* === Overlay difesa legato all’ultima carta attacco === */
function showDefenseCardOnField(cardType, cardName){
  if(gameState.playedCardsOnField.length===0) return;
  const lastAttackCard = gameState.playedCardsOnField[gameState.playedCardsOnField.length-1];

  gameState.defenseCardsOnField.push({
    type: cardType.replace('calcio-dangolo','calcio-angolo'),
    name: cardName,
    attackCardRef: lastAttackCard
  });

  renderFieldCards();
}

/* === Evidenzia giocatore attivo e setup etichette === */
function setActivePlayer(player){
  const attackArea  = document.getElementById('attackArea');
  const defenseArea = document.getElementById('defenseArea');
  const attackLabel = document.getElementById('attackLabel');
  const defenseLabel= document.getElementById('defenseLabel');

  const attackerName = (gameState.firstAttacker==='red') ? gameState.redTeamName : gameState.blueTeamName;
  const defenderName = (gameState.firstAttacker==='red') ? gameState.blueTeamName : gameState.redTeamName;

  if(player==='attack'){
    attackArea.classList.add('active');  attackArea.classList.remove('disabled');
    defenseArea.classList.remove('active'); defenseArea.classList.add('disabled');

    document.getElementById('defenseSidebar').classList.remove('open');
    if(document.getElementById('attackSidebar').classList.contains('open')) renderSidebar('attack');

    attackLabel.innerHTML = `
      <span class="team-name-badge">${attackerName}</span>
      <span class="role-badge attack">⚔️ Attacco</span>
      <button class="btn-view-hand" type="button" onclick="toggleSidebar('attack')">Carte Giocatore</button>
    `;
    defenseLabel.innerHTML = `
      <span class="team-name-badge">${defenderName}</span>
      <span class="role-badge defense">🛡️ Difesa</span>
      <button class="btn-view-hand" type="button" onclick="toggleSidebar('defense')">Carte Giocatore</button>
    `;
  } else {
    defenseArea.classList.add('active'); defenseArea.classList.remove('disabled');
    attackArea.classList.remove('active'); attackArea.classList.add('disabled');

    document.getElementById('attackSidebar').classList.remove('open');
    if(document.getElementById('defenseSidebar').classList.contains('open')) renderSidebar('defense');

    defenseLabel.innerHTML = `
      <span class="team-name-badge">${defenderName}</span>
      <span class="role-badge defense">🛡️ Difesa</span>
      <button class="btn-view-hand" type="button" onclick="toggleSidebar('defense')">Carte Giocatore</button>
    `;
    attackLabel.innerHTML = `
      <span class="team-name-badge">${attackerName}</span>
      <span class="role-badge attack">⚔️ Attacco</span>
      <button class="btn-view-hand" type="button" onclick="toggleSidebar('attack')">Carte Giocatore</button>
    `;
  }
}

/* === RIGORE: inizio/tiro/pesca/esito === */
function handlePenaltyKick(){
  gameState.penaltyInProgress = true;
  gameState.phase = 'penalty-kick';

  const attackerName = (gameState.firstAttacker==='red') ? gameState.redTeamName : gameState.blueTeamName;
  document.getElementById('actionStatus').innerHTML = `
    <div class="result-banner" style="background: linear-gradient(135deg,#F44336,#D32F2F);">🔴 FALLO DA RIGORE!</div>
    <div style="margin-top:10px;font-size:.9em;color:white;">${attackerName} deve giocare una carta ATTACCANTE per tirare il rigore</div>
  `;

  renderFieldCards();
  setActivePlayer('attack');
}

function playPenaltyCard(tipo, pos){
  removeCardFromHand('attack', tipo, pos);

  const attackerName = (gameState.firstAttacker==='red') ? gameState.redTeamName : gameState.blueTeamName;
  document.getElementById('actionStatus').innerHTML = `
    <div class="result-banner" style="background: linear-gradient(135deg,#FF9800,#F57C00);">⚽ RIGORE BATTUTO!</div>
    <div style="margin-top:10px;font-size:.9em;color:white;">${attackerName} ha tirato il rigore!</div>
  `;
  setTimeout(()=>{ resolvePenalty(true); }, 5000);
}

function pescaCartaPerRigore(){
  if(mazzoPescate.length===0){ resolvePenalty(false); return; }

  const fieldCards = document.getElementById('fieldCards');
  fieldCards.innerHTML = '';

  const carta = mazzoPescate.pop();
  attackHandRemaining.push(carta);

  const attackerName = (gameState.firstAttacker==='red') ? gameState.redTeamName : gameState.blueTeamName;
  const cartaNome = carta.pos ? `${carta.tipo.toUpperCase()} ${carta.pos.toUpperCase()}` : carta.tipo.toUpperCase();

  document.getElementById('actionStatus').innerHTML = `
    <div class="result-banner" style="background: linear-gradient(135deg,#F44336,#D32F2F);">🔴 RIGORE!</div>
    <div style="margin-top:10px;font-size:.9em;color:white;">${attackerName} ha pescato: ${cartaNome}</div>
  `;

  if(document.getElementById('attackSidebar').classList.contains('open')) renderSidebar('attack');

  setTimeout(()=>{
    const isAttaccante = (carta.tipo==='attaccante');
    if(isAttaccante){
      document.getElementById('actionStatus').innerHTML = `
        <div class="result-banner" style="background: linear-gradient(135deg,#F44336,#D32F2F);">🔴 RIGORE!</div>
        <div style="margin-top:10px;font-size:.9em;color:white;">${attackerName} può tirare il rigore!</div>
      `;
      renderFieldCards();
    } else {
      document.getElementById('actionStatus').innerHTML = `
        <div class="result-banner fail">❌ RIGORE FALLITO!</div>
        <div style="margin-top:10px;font-size:.9em;color:white;">${attackerName} non ha pescato una carta ATTACCANTE</div>
      `;
      setTimeout(()=>{ resolvePenalty(false); }, 5000);
    }
  }, 5000);
}

function resolvePenalty(goalScored){
  gameState.penaltyInProgress = false;

  const attackerName = (gameState.firstAttacker==='red') ? gameState.redTeamName : gameState.blueTeamName;

  if(goalScored){
    if(gameState.firstAttacker==='red'){ gameState.redScore++; gameState.goalScoredBy='red'; }
    else { gameState.blueScore++; gameState.goalScoredBy='blue'; }

    document.getElementById('redScore').textContent  = gameState.redScore;
    document.getElementById('blueScore').textContent = gameState.blueScore;

    launchConfetti();

    document.getElementById('actionStatus').innerHTML = `
      <div class="result-banner">⚽ RIGORE REALIZZATO!</div>
      <div style="margin-top:10px;font-size:.9em;color:white;">${attackerName} segna su rigore! Cambio possesso</div>
    `;

    setTimeout(()=>{
      const defenderHand = defenseHandRemaining;
      const hasVAR = defenderHand.some(c => c.tipo==='var');
      if(hasVAR) showVARDecision();
      else switchRoles('Cambio possesso dopo rigore', 0, null);
    }, 5000);
  } else {
    document.getElementById('actionStatus').innerHTML = `
      <div class="result-banner fail">❌ RIGORE PARATO!</div>
      <div style="margin-top:10px;font-size:.9em;color:white;">Nessun goal! Cambio possesso</div>
    `;
    setTimeout(()=> switchRoles('Cambio possesso dopo rigore', 0, null), 5000);
  }
}
</script>
<script>
/* === Pesca attacco nel turno normale === */
function pescaCartaGiocatore(){
  if(mazzoPescate.length===0){ checkEndOfHalf(); return; }
  gameState.hasDrawnThisAction = true;

  const carta = mazzoPescate.pop();
  attackHandRemaining.push(carta);

  const attackerName = (gameState.firstAttacker==='red') ? gameState.redTeamName : gameState.blueTeamName;
  const nome = carta.pos ? `${carta.tipo.toUpperCase()} ${carta.pos.toUpperCase()}` : carta.tipo.toUpperCase();
  document.getElementById('actionStatus').textContent = `🎴 ${attackerName} ha pescato: ${nome}`;

  if(document.getElementById('attackSidebar').classList.contains('open')) renderSidebar('attack');

  setTimeout(()=>{
    renderFieldCards();
    if(!hasPlayableCards()) checkEndOfHalf();
  }, 5000);
}

/* === Modale scarti/mazzo + utili === */
function updateTrashButton(){
  const btn = document.getElementById('trashBtn');
  const isEmpty = gameState.redCardsDiscarded.length===0 && gameState.blueCardsDiscarded.length===0;
  btn.disabled = isEmpty;
  btn.style.opacity = isEmpty ? '0.5' : '1';
  btn.style.cursor  = isEmpty ? 'not-allowed' : 'pointer';
}

function openMazzoModal(){
  const grid = document.getElementById('mazzoGrid');
  grid.innerHTML = mazzoPescate.length>0 ? mazzoPescate.map(createSmallCard).join('') : '<div style="color:white;padding:10px;">Mazzo esaurito</div>';
  document.getElementById('mazzoModal').classList.add('open');
}
function closeMazzoModal(){ document.getElementById('mazzoModal').classList.remove('open'); }

function openDiscardModal(){
  document.getElementById('redDiscardTitle').textContent  = `🔴 ${gameState.redTeamName}`;
  document.getElementById('blueDiscardTitle').textContent = `🔵 ${gameState.blueTeamName}`;

  const redGrid = document.getElementById('redDiscardGrid');
  const blueGrid= document.getElementById('blueDiscardGrid');

  redGrid.innerHTML  = gameState.redCardsDiscarded.length>0  ? gameState.redCardsDiscarded.map(createSmallCard).join('')  : '<div style="color:white;padding:10px;">Nessuna carta scartata</div>';
  blueGrid.innerHTML = gameState.blueCardsDiscarded.length>0 ? gameState.blueCardsDiscarded.map(createSmallCard).join('') : '<div style="color:white;padding:10px;">Nessuna carta scartata</div>';

  document.getElementById('discardModal').classList.add('open');
}
function closeDiscardModal(){ document.getElementById('discardModal').classList.remove('open'); }

function createSmallCard(card){
  const posMap = { 'Dx':'DESTRO','Cc':'CENTRALE','Sx':'SINISTRO' };
  if(card.pos){
    return `<div class="carta-small ${card.tipo}">
      <div class="carta-icona">${card.icona}</div>
      <div class="carta-nome">${card.tipo.toUpperCase()}</div>
      <div class="carta-posizione">${posMap[card.pos]}</div>
    </div>`;
  }
  return `<div class="carta-small ${card.tipo}">
    <div class="carta-icona">${card.icona}</div>
    <div class="carta-nome">${card.tipo.replace(/-/g,' ').toUpperCase()}</div>
  </div>`;
}

/* === Cambio possesso & reset turni === */
function switchRoles(reason, startStep=0, startPosition=null){
  gameState.roleChanges++;
  gameState.firstAttacker = (gameState.firstAttacker==='red') ? 'blue' : 'red';
  updateSidebarTitles();

  gameState.phase='attack-turn';
  gameState.step=startStep;
  gameState.attackCardPlayed=null;
  gameState.defenseCardPlayed=null;
  gameState.lastPosition=startPosition;
  gameState.mustReplayCard=null;
  gameState.playedCardsOnField=[];
  gameState.hasDrawnThisAction=false;
  gameState.defenseCardsOnField=[];

  document.getElementById('defenseHand').innerHTML='';
  document.getElementById('fieldCards').innerHTML='';
  document.getElementById('attackSidebar').classList.remove('open');
  document.getElementById('defenseSidebar').classList.remove('open');

  document.getElementById('defenseArea').classList.remove('disabled');
  setActivePlayer('attack');

  const attackerName = (gameState.firstAttacker==='red') ? gameState.redTeamName : gameState.blueTeamName;
  const roles = ['DIFENSORE','MEDIANO','CENTROCAMPISTA','ATTACCANTE'];
  const startInfo = startStep>0 ? ` (riparte da ${roles[startStep]})` : '';
  document.getElementById('actionStatus').textContent = `${attackerName} recupera palla! ${reason}${startInfo}`;

  setTimeout(()=>{
    renderFieldCards();
    if(document.getElementById('attackSidebar').classList.contains('open')) renderSidebar('attack');
  }, 2000);
}

function invertRoles(){
  gameState.firstAttacker = (gameState.firstAttacker==='red') ? 'blue' : 'red';
  updateSidebarTitles();

  gameState.phase='waiting';
  gameState.step=0;
  gameState.attackCardPlayed=null;
  gameState.defenseCardPlayed=null;
  gameState.lastPosition=null;
  gameState.mustReplayCard=null;
  gameState.playedCardsOnField=[];
  gameState.hasDrawnThisAction=false;
  gameState.defenseCardsOnField=[];

  document.getElementById('defenseHand').innerHTML='';
  document.getElementById('fieldCards').innerHTML='';
  document.getElementById('attackSidebar').classList.remove('open');
  document.getElementById('defenseSidebar').classList.remove('open');
  document.getElementById('defenseArea').classList.remove('disabled');

  setActivePlayer('attack');

  const attackerName = (gameState.firstAttacker==='red') ? gameState.redTeamName : gameState.blueTeamName;
  document.getElementById('actionStatus').textContent = `${attackerName} inizia! Clicca "INIZIA AZIONE"`;
}

/* === Reset completo === */
function resetGame(){ location.reload(); }

/* === Gestione tempi di gioco === */
function checkEndOfHalf(){
  if(gameState.currentHalf===1){
    gameState.halfTimeScore.red  = gameState.redScore;
    gameState.halfTimeScore.blue = gameState.blueScore;
    showHalfTimeScreen();
  } else {
    showFinalScore();
  }
}

function showHalfTimeScreen(){
  gameState.phase='half-time';

  document.getElementById('actionStatus').innerHTML = `
    <div class="result-banner" style="background: linear-gradient(135deg,#FF9800,#F57C00);">⏸️ FINE PRIMO TEMPO</div>
    <div style="margin-top:15px;font-size:1.1em;color:white;font-weight:bold;">
      PUNTEGGIO PARZIALE<br>
      ${gameState.redTeamName}: ${gameState.redScore} - ${gameState.blueTeamName}: ${gameState.blueScore}
    </div>
    <div style="margin-top:20px;">
      <button class="btn" type="button" onclick="startSecondHalf()" style="font-size:1.2em;padding:15px 30px;background:linear-gradient(135deg,#4CAF50,#45a049);">
        ▶️ INIZIA SECONDO TEMPO
      </button>
    </div>
  `;

  document.getElementById('attackArea').classList.add('disabled');
  document.getElementById('defenseArea').classList.add('disabled');
  document.getElementById('defenseHand').innerHTML='';
  document.getElementById('fieldCards').innerHTML='';
}

function startSecondHalf(){
  gameState.currentHalf = 2;
  gameState.phase='waiting';
  gameState.step=0;
  gameState.attackCardPlayed=null;
  gameState.defenseCardPlayed=null;
  gameState.lastPosition=null;
  gameState.mustReplayCard=null;
  gameState.roleChanges=0;
  gameState.playedCardsOnField=[];
  gameState.hasDrawnThisAction=false;
  gameState.defenseCardsOnField=[];

  document.getElementById('timeIndicator').textContent='🕐 2° TEMPO';

  // inverti chi inizia
  gameState.firstAttacker = (gameState.firstAttacker==='red') ? 'blue' : 'red';

  // ridistribuzione carte per il 2° tempo
  const full = creaMazzoCompleto();
  const att = full.filter(c => ['difensore','mediano','centrocampista','attaccante'].includes(c.tipo));
  const def = full.filter(c => !['difensore','mediano','centrocampista','attaccante'].includes(c.tipo));
  shuffle(att); shuffle(def);

  const a1 = att.slice(0,15), a2 = att.slice(15,30), aR = att.slice(30);
  const d1 = def.slice(0,6),  d2 = def.slice(6,12),  dR = def.slice(12);

  attackHandRemaining  = [...a1, ...d1];
  defenseHandRemaining = [...a2, ...d2];
  mazzoPescate = [...aR, ...dR];
  shuffle(mazzoPescate);

  gameState.redCardsDiscarded=[]; gameState.blueCardsDiscarded=[];
  updateTrashButton();

  document.getElementById('attackSidebar').classList.remove('open');
  document.getElementById('defenseSidebar').classList.remove('open');
  updateSidebarTitles();

  document.getElementById('attackArea').classList.remove('disabled');
  document.getElementById('defenseArea').classList.remove('disabled');
  document.getElementById('defenseHand').innerHTML='';
  document.getElementById('fieldCards').innerHTML='';

  setActivePlayer('attack');

  const attackerName = (gameState.firstAttacker==='red') ? gameState.redTeamName : gameState.blueTeamName;
  document.getElementById('actionStatus').innerHTML = `
    <div class="result-banner" style="background: linear-gradient(135deg,#4CAF50,#45a049);">🔄 INIZIO SECONDO TEMPO</div>
    <div style="margin-top:10px;font-size:.9em;color:white;">
      ${attackerName} inizia! Clicca "INIZIA AZIONE"
    </div>
  `;
}

function showFinalScore(){
  gameState.phase='ended';
  let resultText='';
  if(gameState.redScore > gameState.blueScore)      resultText = `🏆 VINCE ${gameState.redTeamName.toUpperCase()}!`;
  else if(gameState.blueScore > gameState.redScore) resultText = `🏆 VINCE ${gameState.blueTeamName.toUpperCase()}!`;
  else resultText = '🤝 PAREGGIO!';

  document.getElementById('actionStatus').innerHTML = `
    <div class="result-banner">🏁 FINE PARTITA</div>
    <div style="margin-top:15px;font-size:1.3em;color:white;font-weight:bold;">${resultText}</div>
    <div style="margin-top:10px;font-size:1.1em;color:white;">
      PUNTEGGIO FINALE<br>
      ${gameState.redTeamName}: ${gameState.redScore} - ${gameState.blueTeamName}: ${gameState.blueScore}
    </div>
    <div style="margin-top:20px;">
      <button class="btn btn-reset" type="button" onclick="resetGame()" style="font-size:1.2em;padding:15px 30px;">🔄 NUOVA PARTITA</button>
    </div>
  `;
  document.getElementById('attackArea').classList.add('disabled');
  document.getElementById('defenseArea').classList.add('disabled');
}
</script>
</body>
</html>
